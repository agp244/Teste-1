<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Minhas Finanças — Dashboard</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Scrollbar mobile */
    ::-webkit-scrollbar { height:8px; width:8px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius:8px; }
    /* small animations */
    .card-appear { transform-origin: center; transition: transform .18s ease, box-shadow .18s ease; }
    .card-appear:active { transform: scale(.995); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-50 to-white min-h-screen p-4 font-sans">

  <!-- Top: Saldo Geral -->
  <header class="mb-4">
    <div class="bg-white/80 backdrop-blur-sm rounded-3xl p-4 shadow-lg flex items-center gap-4">
      <div class="flex-1">
        <div class="text-xs text-gray-500">Saldo Geral</div>
        <div id="saldoGeral" class="text-3xl font-extrabold">R$ 0,00</div>
        <div id="subSaldos" class="text-xs text-gray-500 mt-1">—</div>
      </div>
      <div class="w-20 h-20 rounded-xl flex items-center justify-center bg-gradient-to-br from-indigo-500 to-indigo-400 text-white shadow">
        <div class="text-center text-sm">
          <div class="text-xs">App</div>
          <div class="font-semibold">Finanças</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Abas (áreas) -->
  <nav class="mb-4">
    <div class="grid grid-cols-5 gap-2">
      <button data-area="geral" class="area-btn bg-white card-appear rounded-xl p-3 text-center shadow-sm active">
        <div class="text-sm font-semibold text-indigo-600">Geral</div>
      </button>
      <button data-area="cofrinho" class="area-btn bg-white card-appear rounded-xl p-3 text-center shadow-sm">
        <div class="text-sm font-semibold text-yellow-600">Cofrinho</div>
      </button>
      <button data-area="emergencia" class="area-btn bg-white card-appear rounded-xl p-3 text-center shadow-sm">
        <div class="text-sm font-semibold text-red-600">Emergência</div>
      </button>
      <button data-area="fixas" class="area-btn bg-white card-appear rounded-xl p-3 text-center shadow-sm">
        <div class="text-sm font-semibold text-blue-600">Fixas</div>
      </button>
      <button data-area="variaveis" class="area-btn bg-white card-appear rounded-xl p-3 text-center shadow-sm">
        <div class="text-sm font-semibold text-green-600">Variáveis</div>
      </button>
    </div>
  </nav>

  <!-- Filtros (mês e busca) -->
  <div class="mb-3 flex gap-2">
    <select id="periodoFilter" class="flex-1 border rounded-lg p-2 text-sm">
      <option value="all">Todos os meses</option>
    </select>
    <input id="busca" placeholder="Buscar (descrição)" class="w-36 border rounded-lg p-2 text-sm" />
  </div>

  <main id="mainContent" class="space-y-4">

    <!-- Lista e controles -->
    <section id="listaSection" class="bg-white rounded-2xl shadow p-3">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-gray-700">Transações</h3>
        <div class="text-xs text-gray-500" id="contador">0 lançamentos</div>
      </div>
      <ul id="lista" class="space-y-2 max-h-56 overflow-y-auto"></ul>
    </section>

    <!-- Gráficos -->
    <section class="grid grid-cols-1 gap-3">
      <div class="bg-white rounded-2xl shadow p-3">
        <div class="flex justify-between items-center mb-2">
          <h4 class="font-semibold text-gray-700">Resumo (área selecionada)</h4>
          <div class="text-xs text-gray-500" id="periodLabel">Período: Todos</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-2 bg-gray-50 rounded-lg">
            <canvas id="chartAreaPie" height="150"></canvas>
          </div>
          <div class="p-2 bg-gray-50 rounded-lg">
            <canvas id="chartAreaBar" height="150"></canvas>
          </div>
        </div>
      </div>

      <!-- Relatório por categoria/area -->
      <div class="bg-white rounded-2xl shadow p-3">
        <h4 class="font-semibold text-gray-700 mb-2">Relatório detalhado</h4>
        <div id="relatorio" class="text-sm text-gray-600"></div>
      </div>
    </section>

  </main>

  <!-- Botão flutuante -->
  <button id="btnNovo" class="fixed bottom-6 right-6 bg-indigo-600 text-white rounded-full w-16 h-16 text-3xl shadow-2xl">＋</button>

  <!-- Modal (Adicionar / Editar) -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-3xl p-5 shadow-lg">
      <div class="flex justify-between items-center mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Nova transação</h3>
        <button id="closeModal" class="text-gray-400">✕</button>
      </div>

      <div class="space-y-2">
        <input id="inputDescricao" placeholder="Descrição" class="w-full border p-2 rounded"/>
        <div class="flex gap-2">
          <input id="inputValor" type="number" step="0.01" placeholder="Valor R$" class="flex-1 border p-2 rounded"/>
          <select id="inputTipo" class="w-32 border p-2 rounded">
            <option value="entrada">Entrada</option>
            <option value="saida">Saída</option>
          </select>
        </div>

        <div class="flex gap-2">
          <select id="inputArea" class="flex-1 border p-2 rounded">
            <option value="geral">Geral</option>
            <option value="cofrinho">Cofrinho</option>
            <option value="emergencia">Reserva Emergência</option>
            <option value="fixas">Despesas Fixas</option>
            <option value="variaveis">Despesas Variáveis</option>
          </select>
          <input id="inputData" type="date" class="w-40 border p-2 rounded"/>
        </div>

        <input id="inputCategoria" placeholder="Categoria (opcional)" class="w-full border p-2 rounded"/>

        <div class="flex justify-between items-center mt-3">
          <button id="btnCancelar" class="px-4 py-2 rounded bg-gray-100">Cancelar</button>
          <div class="flex gap-2">
            <button id="btnDeletar" class="px-4 py-2 rounded bg-red-50 text-red-600 hidden">Excluir</button>
            <button id="btnSalvar" class="px-4 py-2 rounded bg-indigo-600 text-white">Salvar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -------------------- Config / Estado -------------------- */
const STORAGE_KEY = 'financas_v2_agp';
let transacoes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

/* áreas com cores/títulos */
const AREAS = {
  geral: { label: 'Geral', color: '#6366F1' },         // indigo
  cofrinho: { label: 'Cofrinho', color: '#D97706' },   // amber/dourado
  emergencia: { label: 'Emergência', color: '#DC2626' },// red
  fixas: { label: 'Fixas', color: '#2563EB' },         // blue
  variaveis: { label: 'Variáveis', color: '#16A34A' }  // green
};

let areaSelecionada = 'geral';
let editingIndex = null;

/* DOM */
const areaBtns = document.querySelectorAll('.area-btn');
const saldoGeralEl = document.getElementById('saldoGeral');
const subSaldosEl = document.getElementById('subSaldos');
const listaEl = document.getElementById('lista');
const contadorEl = document.getElementById('contador');
const periodoFilter = document.getElementById('periodoFilter');
const buscaInput = document.getElementById('busca');
const periodLabel = document.getElementById('periodLabel');
const relatorioEl = document.getElementById('relatorio');

const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const btnNovo = document.getElementById('btnNovo');
const closeModal = document.getElementById('closeModal');
const btnCancelar = document.getElementById('btnCancelar');
const btnSalvar = document.getElementById('btnSalvar');
const btnDeletar = document.getElementById('btnDeletar');

const inputDescricao = document.getElementById('inputDescricao');
const inputValor = document.getElementById('inputValor');
const inputTipo = document.getElementById('inputTipo');
const inputArea = document.getElementById('inputArea');
const inputData = document.getElementById('inputData');
const inputCategoria = document.getElementById('inputCategoria');

/* Charts */
let chartPie = null;
let chartBar = null;

/* -------------------- Utils -------------------- */
function todayISO() {
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${mm}-${dd}`;
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(transacoes));
}

/* gerar cores repetitivas */
function generateColors(n) {
  const palette = ['#4ade80','#60a5fa','#f87171','#facc15','#a78bfa','#fb923c','#34d399','#f97316','#60a5fa','#fda4af'];
  const out = [];
  for (let i=0;i<n;i++) out.push(palette[i % palette.length]);
  return out;
}

/* retorna transações filtradas por período, área e busca */
function getFiltered() {
  const periodo = periodoFilter.value; // 'all' or 'YYYY-MM'
  const texto = buscaInput.value.trim().toLowerCase();
  return transacoes.filter(t => {
    if (areaSelecionada !== 'geral') {
      if (t.area !== areaSelecionada) return false;
    } else {
      // em "Geral" mostramos todas as áreas exceto cofrinho? 
      // Aqui definimos: Em Geral mostramos transações com area === 'geral'
      // (transações de cofrinho/emergencia/fixas/variaveis aparecem em suas abas)
      if (t.area !== 'geral') return false;
    }

    if (periodo !== 'all') {
      if (!t.data || !t.data.startsWith(periodo)) return false;
    }

    if (texto) {
      if (!t.descricao.toLowerCase().includes(texto) && !(t.categoria||'').toLowerCase().includes(texto)) return false;
    }
    return true;
  });
}

/* popula select de meses dinamicamente a partir das transações */
function atualizarPeriodos() {
  const set = new Set();
  transacoes.forEach(t => {
    if (t.data) set.add(t.data.slice(0,7));
  });
  const arr = Array.from(set).sort((a,b)=> b.localeCompare(a));
  periodoFilter.innerHTML = '<option value="all">Todos os meses</option>';
  arr.forEach(p => {
    const [y,m] = p.split('-');
    const date = new Date(`${p}-01`);
    const label = date.toLocaleString('pt-BR', { month:'short', year:'numeric' }).replace('.', '');
    const opt = document.createElement('option');
    opt.value = p;
    opt.textContent = label.charAt(0).toUpperCase() + label.slice(1);
    periodoFilter.appendChild(opt);
  });
}

/* calcula totais por área e retorna resumo */
function calcularResumoGlobal() {
  const resumo = {
    saldoGeral: 0,
    porArea: {}
  };
  Object.keys(AREAS).forEach(a => resumo.porArea[a] = 0);

  transacoes.forEach(t => {
    if (t.tipo === 'entrada') {
      resumo.porArea[t.area] += t.valor;
      if (t.area === 'geral') resumo.saldoGeral += t.valor;
    } else {
      resumo.porArea[t.area] -= t.valor;
      if (t.area === 'geral') resumo.saldoGeral -= t.valor;
    }
  });

  return resumo;
}

/* atualiza topo (saldo geral e sub-saldos) */
function atualizarTopo() {
  const r = calcularResumoGlobal();
  saldoGeralEl.textContent = `R$ ${r.saldoGeral.toFixed(2)}`;
  // construir subtítulos com cores
  const parts = Object.keys(AREAS).map(a => {
    const v = r.porArea[a];
    const sign = v >= 0 ? '' : '-';
    const val = `R$ ${Math.abs(v).toFixed(2)}`;
    return `<span style="color:${AREAS[a].color}" class="font-medium">${AREAS[a].label}: ${sign}${val}</span>`;
  });
  subSaldosEl.innerHTML = parts.join(' • ');
}

/* renderizar lista de transações da área */
function renderLista() {
  const arr = getFiltered();
  listaEl.innerHTML = '';
  if (arr.length === 0) {
    listaEl.innerHTML = '<li class="text-gray-400 text-sm py-2">Nenhuma transação</li>';
  } else {
    arr.forEach((t, idx) => {
      // encontrar índice real na lista original para editar/excluir
      const idxReal = transacoes.findIndex(tt => tt === t || (
        tt.descricao === t.descricao && tt.valor === t.valor && tt.tipo === t.tipo &&
        tt.area === t.area && tt.data === t.data && tt.categoria === t.categoria
      ));

      const li = document.createElement('li');
      li.className = 'flex justify-between items-start p-2 rounded-lg hover:bg-gray-50';
      li.innerHTML = `
        <div class="flex gap-3 items-start">
          <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background:${AREAS[t.area].color}22">
            <div class="text-xs" style="color:${AREAS[t.area].color}">${AREAS[t.area].label[0]}</div>
          </div>
          <div>
            <div class="font-medium text-gray-700">${t.descricao}</div>
            <div class="text-xs text-gray-400">${t.categoria || 'Sem categoria'} • ${new Date(t.data).toLocaleDateString('pt-BR')}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="${t.tipo==='entrada' ? 'text-green-600' : 'text-red-600'} font-semibold">
            ${t.tipo==='entrada' ? '+' : '-'} R$ ${Number(t.valor).toFixed(2)}
          </div>
          <div class="flex gap-1 justify-end mt-2">
            <button class="text-xs px-2 py-1 rounded bg-indigo-50 text-indigo-600" onclick="abrirEditar(${idxReal})">Editar</button>
            <button class="text-xs px-2 py-1 rounded bg-red-50 text-red-600" onclick="deletar(${idxReal})">Excluir</button>
          </div>
        </div>
      `;
      listaEl.appendChild(li);
    });
  }
  contadorEl.textContent = `${arr.length} lançamentos`;
}

/* calcular totais da área (para gráficos) */
function calcularTotaisArea() {
  const arr = getFiltered();
  let totalEntradas = 0, totalSaidas = 0;
  const porCategoria = {};
  arr.forEach(t => {
    if (t.tipo === 'entrada') totalEntradas += t.valor;
    else totalSaidas += t.valor;
    const cat = t.categoria || 'Sem categoria';
    porCategoria[cat] = (porCategoria[cat] || 0) + t.valor;
  });
  return { totalEntradas, totalSaidas, porCategoria };
}

/* atualizar gráficos (pie por categoria + barras entrada/saída) */
function atualizarGraficos() {
  const { totalEntradas, totalSaidas, porCategoria } = calcularTotaisArea();

  // PIE
  const ctxPie = document.getElementById('chartAreaPie');
  if (chartPie) chartPie.destroy();
  const labels = Object.keys(porCategoria);
  const dataPie = Object.values(porCategoria);
  chartPie = new Chart(ctxPie, {
    type: 'pie',
    data: { labels, datasets: [{ data: dataPie, backgroundColor: generateColors(labels.length) }]},
    options: { plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: ctx => `R$ ${Number(ctx.raw).toFixed(2)}` }}}}
  });

  // BAR
  const ctxBar = document.getElementById('chartAreaBar');
  if (chartBar) chartBar.destroy();
  chartBar = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: ['Entradas', 'Saídas'],
      datasets: [{ label: 'R$', data: [totalEntradas, totalSaidas], backgroundColor: [ '#10B981', '#EF4444' ] }]
    },
    options: { plugins: { legend: { display: false } } }
  });

  // relatório detalhado (categoria)
  const rows = Object.entries(porCategoria).sort((a,b)=>b[1]-a[1]);
  if (rows.length===0) {
    relatorioEl.innerHTML = '<div class="text-gray-400 text-sm">Sem dados para exibir.</div>';
  } else {
    const total = rows.reduce((s,r)=>s+r[1],0);
    let html = '<table class="w-full text-sm"><thead class="text-xs text-gray-500"><tr><th>Categoria</th><th class="text-right">Total</th><th class="text-right">%</th></tr></thead><tbody>';
    rows.forEach(([cat, val]) => {
      html += `<tr class="border-t"><td class="py-2">${cat}</td><td class="py-2 text-right">R$ ${val.toFixed(2)}</td><td class="py-2 text-right">${(val/total*100).toFixed(1)}%</td></tr>`;
    });
    html += `</tbody><tfoot class="border-t font-semibold"><tr><td class="py-2">Total</td><td class="py-2 text-right">R$ ${total.toFixed(2)}</td><td class="py-2 text-right">100%</td></tr></tfoot></table>`;
    relatorioEl.innerHTML = html;
  }
}

/* atualizar tudo */
function atualizarTudo() {
  atualizarPeriodos();
  atualizarTopo();
  renderLista();
  atualizarGraficos();
  save();
  // label do período
  periodLabel.textContent = periodoFilter.value === 'all' ? 'Período: Todos' : `Período: ${periodoFilter.options[periodoFilter.selectedIndex].text}`;
}

/* -------------------- Ações (abrir modal, salvar, editar, deletar) -------------------- */
function abrirModalNovo() {
  editingIndex = null;
  modalTitle.textContent = 'Nova transação';
  inputDescricao.value = '';
  inputValor.value = '';
  inputTipo.value = 'saida';
  inputArea.value = areaSelecionada || 'geral';
  inputCategoria.value = '';
  inputData.value = todayISO();
  btnDeletar.classList.add('hidden');
  modal.classList.remove('hidden');
  setTimeout(()=>inputDescricao.focus(),150);
}

function abrirEditar(index) {
  const t = transacoes[index];
  if (!t) return;
  editingIndex = index;
  modalTitle.textContent = 'Editar transação';
  inputDescricao.value = t.descricao;
  inputValor.value = t.valor;
  inputTipo.value = t.tipo;
  inputArea.value = t.area;
  inputCategoria.value = t.categoria || '';
  inputData.value = t.data || todayISO();
  btnDeletar.classList.remove('hidden');
  modal.classList.remove('hidden');
  setTimeout(()=>inputDescricao.focus(),150);
}

function fecharModal() {
  modal.classList.add('hidden');
}

/* salvar (novo ou editar) */
function salvarTransacao() {
  const desc = inputDescricao.value.trim();
  const val = parseFloat(inputValor.value);
  const tipo = inputTipo.value;
  const area = inputArea.value;
  const cat = inputCategoria.value.trim();
  const data = inputData.value || todayISO();

  if (!desc || isNaN(val) || val <= 0) {
    alert('Preencha descrição e valor (>0).');
    return;
  }

  const obj = { descricao: desc, valor: Math.abs(val), tipo, area, categoria: cat, data };

  if (editingIndex === null) {
    transacoes.push(obj);
  } else {
    transacoes[editingIndex] = obj;
  }

  fecharModal();
  atualizarTudo();
}

/* deletar */
function deletar(index) {
  if (!confirm('Deseja excluir esta transação?')) return;
  transacoes.splice(index,1);
  atualizarTudo();
  fecharModal();
}

/* abrir editar via global (onclick) */
window.abrirEditar = abrirEditar;
window.deletar = function(i) { deletar(i); };

/* -------------------- Eventos UI -------------------- */
btnNovo.addEventListener('click', abrirModalNovo);
closeModal.addEventListener('click', fecharModal);
btnCancelar.addEventListener('click', fecharModal);
btnSalvar.addEventListener('click', salvarTransacao);
btnDeletar.addEventListener('click', () => { if (editingIndex !== null) deletar(editingIndex); });

areaBtns.forEach(b => {
  b.addEventListener('click', () => {
    areaBtns.forEach(x => x.classList.remove('ring-2','ring-indigo-200','bg-indigo-50'));
    b.classList.add('ring-2','ring-indigo-200','bg-indigo-50');
    areaSelecionada = b.getAttribute('data-area');
    // ajustar inputArea default
    inputArea.value = areaSelecionada;
    atualizarTudo();
  });
});

/* filtros */
periodoFilter.addEventListener('change', atualizarTudo);
buscaInput.addEventListener('input', () => {
  // debounce simples
  clearTimeout(buscaInput._t);
  buscaInput._t = setTimeout(atualizarTudo, 250);
});

/* inicial: garantir datas compatibilidade */
transacoes = transacoes.map(t => {
  if (!t.data) t.data = todayISO();
  return t;
});

/* set default data on input */
inputData.value = todayISO();

/* inicializar com demo se vazio (opcional) - removível */
if (transacoes.length === 0) {
  // Exemplo inicial (comentar se não quiser dados de exemplo)
  transacoes.push(
    { descricao: 'Salário', valor: 2500, tipo: 'entrada', area: 'geral', categoria: 'Renda', data: todayISO() },
    { descricao: 'Aluguel', valor: 700, tipo: 'saida', area: 'fixas', categoria: 'Moradia', data: todayISO() },
    { descricao: 'Supermercado', valor: 180, tipo: 'saida', area: 'variaveis', categoria: 'Mercado', data: todayISO() },
    { descricao: 'Poupança - Depósito', valor: 200, tipo: 'entrada', area: 'cofrinho', categoria: 'Poupança', data: todayISO() },
    { descricao: 'Reserva Emergência - Aplicação', valor: 100, tipo: 'entrada', area: 'emergencia', categoria: 'Reserva', data: todayISO() }
  );
  save();
}

/* marcar botão da área inicial visual */
document.querySelector('.area-btn[data-area="geral"]').classList.add('ring-2','ring-indigo-200','bg-indigo-50');

/* primeira atualização */
atualizarTudo();

</script>
</body>
</html>
